<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.552">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Commodity Prices Index - Documentation for the price index computation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Commodity Prices Index</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../doc_un/index.html"> 
<span class="menu-text">Documentation</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/chizapoth/un-commodity-prices"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#metadata" id="toc-metadata" class="nav-link active" data-scroll-target="#metadata">Metadata</a></li>
  <li><a href="#data-collection-and-processing" id="toc-data-collection-and-processing" class="nav-link" data-scroll-target="#data-collection-and-processing">Data collection and processing</a>
  <ul class="collapse">
  <li><a href="#data-collection" id="toc-data-collection" class="nav-link" data-scroll-target="#data-collection">Data collection</a>
  <ul class="collapse">
  <li><a href="#world-bank" id="toc-world-bank" class="nav-link" data-scroll-target="#world-bank">World Bank</a></li>
  <li><a href="#imf" id="toc-imf" class="nav-link" data-scroll-target="#imf">IMF</a></li>
  </ul></li>
  <li><a href="#fao" id="toc-fao" class="nav-link" data-scroll-target="#fao">FAO</a></li>
  <li><a href="#merge" id="toc-merge" class="nav-link" data-scroll-target="#merge">Merge</a></li>
  </ul></li>
  <li><a href="#quality-checks" id="toc-quality-checks" class="nav-link" data-scroll-target="#quality-checks">Quality checks</a></li>
  <li><a href="#price-index-computation" id="toc-price-index-computation" class="nav-link" data-scroll-target="#price-index-computation">Price index computation</a>
  <ul class="collapse">
  <li><a href="#weights" id="toc-weights" class="nav-link" data-scroll-target="#weights">Weights</a></li>
  <li><a href="#combine-weight-with-metadata" id="toc-combine-weight-with-metadata" class="nav-link" data-scroll-target="#combine-weight-with-metadata">Combine weight with metadata</a></li>
  <li><a href="#within-product-weights" id="toc-within-product-weights" class="nav-link" data-scroll-target="#within-product-weights">Within product weights</a></li>
  <li><a href="#compute-index" id="toc-compute-index" class="nav-link" data-scroll-target="#compute-index">Compute index</a>
  <ul class="collapse">
  <li><a href="#test-out-for-one-series" id="toc-test-out-for-one-series" class="nav-link" data-scroll-target="#test-out-for-one-series">Test out for one series</a></li>
  <li><a href="#repeat-for-all-commodities" id="toc-repeat-for-all-commodities" class="nav-link" data-scroll-target="#repeat-for-all-commodities">Repeat for all commodities</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Documentation for the price index computation</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(openxlsx)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(zoo)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># source the utility functions</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'~/Documents/GitHub/un-commodity-prices/dev_prices/util.R'</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># set data paths</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>read_path <span class="ot">&lt;-</span> <span class="st">'~/Documents/GitHub/un-commodity-prices/data-raw/'</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>dir_metadata <span class="ot">&lt;-</span> <span class="st">'metadata/'</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>dir_datasource_2024 <span class="ot">&lt;-</span> <span class="st">'datasource_2024/'</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>dir_datasource_2025 <span class="ot">&lt;-</span> <span class="st">'datasource_2025/'</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># write_path &lt;- '~/Documents/GitHub/unctad-int/dev_prices/results/'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="metadata" class="level2">
<h2 class="anchored" data-anchor-id="metadata">Metadata</h2>
<p>First load the <strong>metadata</strong> that contains information for extracting the relevant columns from the international sources.</p>
<p>The content of metadata:</p>
<ul>
<li><code>index_sort</code>: 4-digits ID used to compute price index</li>
<li><code>series_id</code>: 8 digits ID for specific commodity</li>
<li><code>description_long</code>: detailed description of commodity for 2024 sources</li>
<li><code>unit_2024</code>: unit used as in the description (2024 sources). This might not be the same as in the 2025 sources. <span style="color:red">add a footnote</span></li>
<li><code>data_source_2024_code</code>, <code>data_source_2024</code>: code and description for data sources used in 2024 version. For example, 5110 is World Bank Commodity markets.</li>
<li><code>data_source_2025_code</code>, <code>data_source_2025</code>: code and description for data sources used in 2025 version.</li>
<li><code>label_display</code>: commodity name, used for graphics</li>
<li><code>label_source_2025</code>: commodity name as in their 2025 data sources. It is important to match the correct names to the latest data. <span style="color:red">this step needs to be emphasized</span></li>
<li><code>check_two_sources</code>: indicator of whether the sources are switched from 2024 to 2025. If yes, then quality check graphics will be produced.</li>
<li><code>keep</code>: indicator of whether we keep the series in the price index computation.</li>
<li><code>within_product_weight</code>: weight for products that share the same <code>index_sort</code>. For now only applies to coffee and oil. <span style="color:red">more info see index computation</span></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>metadata <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="fu">paste0</span>(read_path, </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                             dir_metadata, </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                             <span class="st">'commodity_metadata.xlsx'</span>), </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sheet =</span> <span class="st">'commodity'</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(metadata, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  index_sort series_id description_short
1       1005 020100.01              beef
2       1010 030212.01       fish_salmon
3       1011 030613.01       shrimps_mex
                                            description_long  unit_2024
1   Beef, Australia/New Zealand, frozen, CIF US ports ($/kg) usd_per_kg
2 Salmon, fresh, fish-farm bred, export price, Norway ($/kg) usd_per_kg
3   Shrimps, brown, no. 1, shell-on, headless, Mexico ($/kg) usd_per_kg
  data_source_2024_code               data_source_2024 data_source_2025_code
1                  5110 World Bank - Commodity-markets                  5110
2                  7801              Statistics Norway                  2311
3                  5110 World Bank - Commodity-markets                  5110
                data_source_2025     label_display label_source_2025
1 World Bank - Commodity-markets              Beef           Beef.**
2 IMF - Primary Commodity Prices     Fish (Salmon)             PSALM
3 World Bank - Commodity-markets Shrimps (Mexican)  Shrimps..Mexican
  check_two_sources keep within_product_weight
1              &lt;NA&gt;  yes                     1
2               yes  yes                     1
3              &lt;NA&gt;  yes                     1</code></pre>
</div>
</div>
</section>
<section id="data-collection-and-processing" class="level1">
<h1>Data collection and processing</h1>
<p>In this step we gather the data from their original sources, then carry out some processing. The end result at this step is a data frame with all the commodity series ready to enter the computation.</p>
<section id="data-collection" class="level2">
<h2 class="anchored" data-anchor-id="data-collection">Data collection</h2>
<section id="world-bank" class="level3">
<h3 class="anchored" data-anchor-id="world-bank">World Bank</h3>
<p><span style="color:red">Note: data file needs to be replaced by API link!</span></p>
<p>We load the data first, then do some processing: convert the prices into numeric values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the raw data (to be replaced by API)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>wb_raw <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="fu">paste0</span>(read_path, </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                           dir_datasource_2025, </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"CMO-Historical-Data-Monthly.xlsx"</span>), </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">sheet =</span> <span class="st">"Monthly Prices"</span>, <span class="at">startRow =</span> <span class="dv">5</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># print the column names and location</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>wb_var <span class="ot">&lt;-</span> <span class="fu">get_info_wb</span>(wb_raw)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># make the values numeric</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>wb <span class="ot">&lt;-</span> <span class="fu">process_data_wb</span>(<span class="at">data =</span> wb_raw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now select the relevant commodities, as defined by <strong>metadata</strong>. We choose the ones where <code>data_source_2025_code == 5110</code> (world bank).</p>
<p>Some of the labels might have special characters, hence we replace them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>wb_info <span class="ot">&lt;-</span> <span class="fu">filter</span>(metadata, data_source_2025_code <span class="sc">==</span> <span class="dv">5110</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(label_source_2025))</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># double check if this is what we need</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># process the labels to remove the special characters</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>wb_labels <span class="ot">&lt;-</span> wb_info<span class="sc">$</span>label_source_2025</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>wb_labels <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">','</span>, <span class="st">'.'</span>, wb_labels) <span class="co"># substitute the commas</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>wb_labels <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">'</span><span class="sc">\\</span><span class="st">*'</span>, <span class="st">'.'</span>, wb_labels) <span class="co"># substitute the star (careful since it's wildcard)</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>wb_labels <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">'%'</span>, <span class="st">'.'</span>, wb_labels) <span class="co"># substitute the commas</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>wb_labels</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Beef..."                 "Shrimps..Mexican"       
 [3] "Banana..US"              "Coffee..Arabica"        
 [5] "Coffee..Robusta"         "Tea..Mombasa"           
 [7] "Wheat..US.HRW"           "Maize"                  
 [9] "Rice..Thai.5."           "Soybeans"               
[11] "Soybean.meal"            "Cotton..A.Index"        
[13] "Soybean.oil"             "Groundnut.oil..."       
[15] "Palm.oil"                "Sunflower.oil"          
[17] "Coconut.oil"             "Palm.kernel.oil"        
[19] "Sugar..world"            "Cocoa"                  
[21] "Fish.meal"               "Tobacco..US.import.u.v."
[23] "Phosphate.rock"          "Iron.ore..cfr.spot"     
[25] "Copper"                  "Nickel"                 
[27] "Aluminum"                "Lead"                   
[29] "Zinc"                    "Tin"                    
[31] "Silver"                  "Coal..Australian"       
[33] "Crude.oil..Brent"        "Crude.oil..Dubai"       
[35] "Natural.gas.index"       "Rubber..TSR20..."       
[37] "Rubber..RSS3"            "Logs..Cameroon"         
[39] "Sawnwood..Malaysian"     "Plywood"                
[41] "Gold"                    "Platinum"               </code></pre>
</div>
</div>
<p>Above are the variable names that correspond to the world bank data file. Now we carry out the selection: keep <code>year</code>, <code>period</code>, <code>time</code>, <code>datetime</code> and the commodity labels.</p>
<p>Since some labels are long, we set new names.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select based on names</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>wb_narrow <span class="ot">&lt;-</span> <span class="fu">select</span>(wb, year, period, time, datetime, <span class="fu">all_of</span>(wb_labels))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># reset the colnames</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(wb_narrow)[<span class="dv">5</span><span class="sc">:</span><span class="fu">ncol</span>(wb_narrow)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Beef..."                 "Shrimps..Mexican"       
 [3] "Banana..US"              "Coffee..Arabica"        
 [5] "Coffee..Robusta"         "Tea..Mombasa"           
 [7] "Wheat..US.HRW"           "Maize"                  
 [9] "Rice..Thai.5."           "Soybeans"               
[11] "Soybean.meal"            "Cotton..A.Index"        
[13] "Soybean.oil"             "Groundnut.oil..."       
[15] "Palm.oil"                "Sunflower.oil"          
[17] "Coconut.oil"             "Palm.kernel.oil"        
[19] "Sugar..world"            "Cocoa"                  
[21] "Fish.meal"               "Tobacco..US.import.u.v."
[23] "Phosphate.rock"          "Iron.ore..cfr.spot"     
[25] "Copper"                  "Nickel"                 
[27] "Aluminum"                "Lead"                   
[29] "Zinc"                    "Tin"                    
[31] "Silver"                  "Coal..Australian"       
[33] "Crude.oil..Brent"        "Crude.oil..Dubai"       
[35] "Natural.gas.index"       "Rubber..TSR20..."       
[37] "Rubber..RSS3"            "Logs..Cameroon"         
[39] "Sawnwood..Malaysian"     "Plywood"                
[41] "Gold"                    "Platinum"               </code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(wb_narrow)[<span class="dv">5</span><span class="sc">:</span><span class="fu">ncol</span>(wb_narrow)] <span class="ot">&lt;-</span> wb_info<span class="sc">$</span>description_short</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="imf" class="level3">
<h3 class="anchored" data-anchor-id="imf">IMF</h3>
<p>Carry out similar tasks for the IMF data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>imf_raw <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="fu">paste0</span>(read_path, </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                             dir_datasource_2025, </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"imf.xls"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
• `POILAPSP` -&gt; `POILAPSP...17`
• `POILAPSP` -&gt; `POILAPSP...45`
• `` -&gt; `...89`
• `` -&gt; `...90`
• `` -&gt; `...91`
• `` -&gt; `...92`
• `` -&gt; `...93`
• `` -&gt; `...94`
• `` -&gt; `...95`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check variables</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>imf_var <span class="ot">&lt;-</span> <span class="fu">get_info_imf</span>(imf_raw)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># View(imf_var)</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># process data, conver to numerics</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>imf <span class="ot">&lt;-</span> <span class="fu">process_data_imf</span>(imf_raw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The last few columns are a bit messy, we manually set the name for <strong>Manganese</strong>. Please double check if this is what you need!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># need to fill in Manganese</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>imf <span class="ot">&lt;-</span> <span class="fu">fill_imf_name</span>(<span class="at">data =</span> imf, </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">keyword =</span> <span class="st">'Mang'</span>, </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">col_to_fill =</span> <span class="st">'...92'</span>, </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">fill_name =</span> <span class="st">'PMANG'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Select the variables defined in <strong>metadata</strong>: where <code>data_source_2025_code == 2311</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select </span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>imf_info <span class="ot">&lt;-</span> <span class="fu">filter</span>(metadata, data_source_2025_code <span class="sc">==</span> <span class="dv">2311</span> <span class="sc">&amp;</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                     <span class="sc">!</span><span class="fu">is.na</span>(label_source_2025) <span class="sc">&amp;</span> keep <span class="sc">==</span> <span class="st">'yes'</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>imf_info</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  index_sort series_id description_short
1       1010 030212.01       fish_salmon
2       3002 260200.02      manganese_99
3       2006 410100.01             hides
4       2004 510100.03         wool_fine
                                                                   description_long
1                        Salmon, fresh, fish-farm bred, export price, Norway ($/kg)
2     Manganese 99.7% electrolytic manganese flake, free market, in warehouse ($/t)
3 Cattle hides, US Chicago packer's heavy native steers, FOB shipping point (¢/lb.)
4                         Fine wool, 19 Micron, AWEX auction price, Australia ($/t)
      unit_2024 data_source_2024_code                 data_source_2024
1    usd_per_kg                  7801                Statistics Norway
2 usd_per_tonne                  6801           Metal Bulletin Limited
3   cent_per_lb                  2311   IMF - Primary Commodity Prices
4 usd_per_tonne                  8001 Australian Wool Innovation (AWI)
  data_source_2025_code               data_source_2025  label_display
1                  2311 IMF - Primary Commodity Prices  Fish (Salmon)
2                  2311 IMF - Primary Commodity Prices Manganese 99.7
3                  2311 IMF - Primary Commodity Prices          Hides
4                  2311 IMF - Primary Commodity Prices    Wool (fine)
  label_source_2025 check_two_sources keep within_product_weight
1             PSALM               yes  yes                     1
2             PMANG               yes  yes                     1
3             PHIDE               yes  yes                     1
4            PWOOLF               yes  yes                     1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select relevant columns</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>imf_narrow <span class="ot">&lt;-</span> <span class="fu">select</span>(imf, year, datetime, <span class="fu">all_of</span>(imf_info<span class="sc">$</span>label_source_2025))</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># reset name </span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(imf_narrow)[<span class="dv">3</span><span class="sc">:</span><span class="fu">ncol</span>(imf_narrow)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "PSALM"  "PMANG"  "PHIDE"  "PWOOLF"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(imf_narrow)[<span class="dv">3</span><span class="sc">:</span><span class="fu">ncol</span>(imf_narrow)] <span class="ot">&lt;-</span> imf_info<span class="sc">$</span>description_short</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="fao" class="level2">
<h2 class="anchored" data-anchor-id="fao">FAO</h2>
<p>The mechanism is slightly different for FAO. First grab the name (<code>Jute</code>), then query it based on <code>uuid</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first get metadata</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>fpma_api <span class="ot">&lt;-</span> <span class="fu">GET</span>(<span class="st">"https://fpma.fao.org/giews/v4/price_module/api/v1/FpmaSerieInternational/"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>fpma_raw <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="fu">rawToChar</span>(fpma_api<span class="sc">$</span>content))</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># str(fpma_raw)</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>fpma_data <span class="ot">&lt;-</span> fpma_raw<span class="sc">$</span>results</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># get information for jute</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># do the same for other commodity if needed</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>jute_info <span class="ot">&lt;-</span> <span class="fu">filter</span>(fpma_data, <span class="fu">grepl</span>(<span class="st">'Jute'</span>, commodity_name))</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>jute_info</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                  uuid iso3_country_code         country_name
1 5a272e65-e437-41c2-bcb0-f229dc14f47b               IPS INTERNATIONAL PRICES
                      periodicity market market_name market_info market_type
1 monthly, 2024-04-01, 2004-01-01   1750  Bangladesh                  Export
  admin_unit admin_unit2 commodity
1                             2711
                                                                 commodity_name
1 Jute BWD (f.o.b. Mongla, at sight)/from 2006 Jute BTD (f.o.b Bangladesh Port)
  commodity_info commodity_image commodity_code commodity_start_date
1                             NA      CMM530300                    1
  alternative_code alternative_name source
1                                      323
                                                                  source_name
1 Bangladesh Jute Mills Corporation/The Public Ledger/Wilhelm G. Clasen (WGC)
  source_url price_type_id price_type currency measure_unit measure_unit_label
1                       11     EXPORT      USD         3555              tonne
  conversion_factor
1             0.001</code></pre>
</div>
</div>
<p>We use the <code>uuid</code> to get the jute data. Double check the period where the data is available (it is only from 2004.1 to 2024.1).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>jute_raw <span class="ot">&lt;-</span> <span class="fu">GET</span>(<span class="fu">paste0</span>(<span class="st">"https://fpma.fao.org/giews/v4/price_module/api/v1/FpmaSeriePrice/"</span>,jute_info<span class="sc">$</span>uuid,<span class="st">"/"</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>jute <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="fu">rawToChar</span>(jute_raw<span class="sc">$</span>content))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># only from 2004.1 to 2024.1</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(jute<span class="sc">$</span>datapoints)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       id price_value price_value_real price_value_dollar conversion_factor
1 5070349         840               NA                840             0.001
2 5070348         780               NA                780             0.001
3 5070347         820               NA                820             0.001
4 5070346         850               NA                850             0.001
5 5070345         700               NA                700             0.001
6 5070344         670               NA                670             0.001
        date periodicity
1 2024-04-01     monthly
2 2024-03-01     monthly
3 2024-02-01     monthly
4 2024-01-01     monthly
5 2023-12-01     monthly
6 2023-11-01     monthly</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(jute<span class="sc">$</span>datapoints)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        id price_value price_value_real price_value_dollar conversion_factor
239 612511         290               NA                290             0.001
240 612510         290               NA                290             0.001
241 612509         290               NA                290             0.001
242 612508         245               NA                245             0.001
243 612507         245               NA                245             0.001
244 612506         230               NA                230             0.001
          date periodicity
239 2004-06-01     monthly
240 2004-05-01     monthly
241 2004-04-01     monthly
242 2004-03-01     monthly
243 2004-02-01     monthly
244 2004-01-01     monthly</code></pre>
</div>
</div>
<p>Convert to proper format to prepare for merging.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>jute <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(jute<span class="sc">$</span>datapoints[, <span class="fu">c</span>(<span class="st">'date'</span>, <span class="st">'price_value_dollar'</span>)])</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(jute)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">'datetime'</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(jute)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">'jute'</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>jute<span class="sc">$</span>datetime <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(jute<span class="sc">$</span>datetime)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="merge" class="level2">
<h2 class="anchored" data-anchor-id="merge">Merge</h2>
<p>We carry out a <strong>left_join</strong> on the three data sets. The keywords that we join by are the <strong>date times</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>dcommodity <span class="ot">&lt;-</span> <span class="fu">left_join</span>(wb_narrow, imf_narrow) <span class="sc">|&gt;</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(jute)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(year, datetime)`
Joining with `by = join_by(datetime)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(dcommodity)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "year"             "period"           "time"             "datetime"        
 [5] "beef"             "shrimps_mex"      "banana_us"        "coffee_arabica"  
 [9] "coffee_robusta"   "tea_mombasa"      "wheat_us"         "maize"           
[13] "rice"             "soybeans"         "soybean_meal"     "cotton"          
[17] "soybean_oil"      "groundnut_oil"    "palm_oil"         "sunflower_oil"   
[21] "coconut_oil"      "palmkernel_oil"   "sugar"            "cocoa"           
[25] "fish_meal"        "tobacco"          "phosphate_rock"   "iron_ore"        
[29] "copper"           "nickel"           "aluminium"        "lead"            
[33] "zinc"             "tin"              "silver"           "coal"            
[37] "crude_oil_brent"  "crude_oil_dubai"  "naturalgas_index" "rubber_tsr20"    
[41] "rubber_rss3"      "logs_cameroon"    "sawnwood"         "plywood"         
[45] "gold"             "platinum"         "fish_salmon"      "manganese_99"    
[49] "hides"            "wool_fine"        "jute"            </code></pre>
</div>
</div>
</section>
</section>
<section id="quality-checks" class="level1">
<h1>Quality checks</h1>
<p><span style="color:red">TO DO: </span></p>
<ul>
<li>summary for the price series, including dates</li>
<li><span style="color:red">need to backfill some data for those unavailable</span></li>
</ul>
</section>
<section id="price-index-computation" class="level1">
<h1>Price index computation</h1>
<p>This is the step for computing the prices using the weights. One important thing to note is that the <strong>weight matrix does not have the 8 digits code</strong> for individual series, so we need to have one additional step of linking these two tables.</p>
<section id="weights" class="level2">
<h2 class="anchored" data-anchor-id="weights">Weights</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>weights <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="fu">paste0</span>(read_path, dir_metadata, <span class="st">'weights.xlsx'</span>))</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(weights)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  index_sort    group subgroup index_description           w           s
1       1001 ALL FOOD     FOOD             Wheat  2206573845 0.001966377
2       1002 ALL FOOD     FOOD             Maize 10035445721 0.008943037
3       1003 ALL FOOD     FOOD              Rice 12086634062 0.010770943
4       1004 ALL FOOD     FOOD             Sugar 18309075031 0.016316040
5       1005 ALL FOOD     FOOD       Bovine meat 10935950196 0.009745517
6       1006 ALL FOOD     FOOD           Bananas  7314470514 0.006518253
  available
1       yes
2       yes
3       yes
4       yes
5       yes
6       yes</code></pre>
</div>
</div>
<p>The content of weight data:</p>
<ul>
<li><code>index_sort</code>: 4-digits ID used to compute price index. Link to <strong>metadata</strong>.</li>
<li><code>group</code>: first level of grouping of commodity</li>
<li><code>subgroup</code>: second level of grouping</li>
<li><code>index_description</code>: description of the index. This does not necessarily link to metadata; however it is indicative to the product used.</li>
<li><code>w</code> and <code>s</code>: numeric values used to compute the weighted sum of the index. <code>s</code> sum up to 1, while <code>w</code> for each product divided by the total sum of w equals to <code>s</code> (hence equivalent).</li>
<li><code>available</code>: indicator of whether this product is available in the data source in 2025.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># shares sum up to 1</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>weights<span class="sc">$</span>s <span class="sc">|&gt;</span> <span class="fu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
</section>
<section id="combine-weight-with-metadata" class="level2">
<h2 class="anchored" data-anchor-id="combine-weight-with-metadata">Combine weight with metadata</h2>
<p>This step produces a table that provides information that links price series to their weights.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(metadata, keep <span class="sc">==</span> <span class="st">'yes'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(index_sort, </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>         series_id, </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>         description_short, </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>         within_product_weight)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>m <span class="sc">|&gt;</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  index_sort series_id description_short within_product_weight
1       1005 020100.01              beef                   1.0
2       1010 030212.01       fish_salmon                   1.0
3       1011 030613.01       shrimps_mex                   1.0
4       1006 080300.01         banana_us                   1.0
5       1101 090100.03    coffee_arabica                   0.4
6       1101 090100.05    coffee_robusta                   0.6</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>ws <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(weights, available <span class="sc">==</span> <span class="st">'yes'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(index_sort, </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>         group, </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>         subgroup,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>         index_description,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>         s)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>ws <span class="sc">|&gt;</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  index_sort    group subgroup index_description           s
1       1001 ALL FOOD     FOOD             Wheat 0.001966377
2       1002 ALL FOOD     FOOD             Maize 0.008943037
3       1003 ALL FOOD     FOOD              Rice 0.010770943
4       1004 ALL FOOD     FOOD             Sugar 0.016316040
5       1005 ALL FOOD     FOOD       Bovine meat 0.009745517
6       1006 ALL FOOD     FOOD           Bananas 0.006518253</code></pre>
</div>
</div>
</section>
<section id="within-product-weights" class="level2">
<h2 class="anchored" data-anchor-id="within-product-weights">Within product weights</h2>
<p>Double check how many rows there are. They might be different.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">nrow</span>(m), <span class="fu">nrow</span>(ws))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 47 44</code></pre>
</div>
</div>
<p>The within-product weight is defined in the <strong>metadata</strong>. For most products this value is 1, exceptions apply to two products:</p>
<ul>
<li>index sort code 1101: <strong>Coffee</strong> Arabica (090100.03) and Robusta (090100.05) takes up 40% and 60%</li>
<li>index sort code 4201: <strong>Crude oil</strong> - Brent (270900.01) and Dubai (270900.02) takes up 50% each</li>
</ul>
<p>Special case:</p>
<ul>
<li>index sort code 2010: <strong>Rubber</strong> RSS3 (400100.02) and TSR20 (400100.01). We use RSS3 as it is complete, while TSR20 is only available from 1999 in World Bank Data. The within-product weight becomes 1 and 0 respectively.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># only 1101 (coffee), 2010 (rubber) 4201 (crude oil) have more frequency</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(m<span class="sc">$</span>index_sort) <span class="sc">|&gt;</span> <span class="fu">sort</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
1001 1002 1003 1004 1005 1006 1008 1010 1011 1102 1103 1201 1202 1203 1204 1206 
   1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1 
1207 1208 2001 2002 2003 2004 2005 2006 2007 2008 2009 3001 3002 3003 3004 3005 
   1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1 
3006 3007 3008 3009 3101 3102 3103 4001 4101 1101 2010 4201 
   1    1    1    1    1    1    1    1    1    2    2    2 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="fu">full_join</span>(m, ws, <span class="at">by =</span> <span class="st">'index_sort'</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(M)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  index_sort series_id description_short within_product_weight    group
1       1005 020100.01              beef                   1.0 ALL FOOD
2       1010 030212.01       fish_salmon                   1.0 ALL FOOD
3       1011 030613.01       shrimps_mex                   1.0 ALL FOOD
4       1006 080300.01         banana_us                   1.0 ALL FOOD
5       1101 090100.03    coffee_arabica                   0.4 ALL FOOD
6       1101 090100.05    coffee_robusta                   0.6 ALL FOOD
            subgroup index_description           s
1               FOOD       Bovine meat 0.009745517
2               FOOD              Fish 0.002242046
3               FOOD       Crustaceans 0.010791602
4               FOOD           Bananas 0.006518253
5 TROPICAL BEVERAGES            Coffee 0.014538625
6 TROPICAL BEVERAGES            Coffee 0.014538625</code></pre>
</div>
</div>
</section>
<section id="compute-index" class="level2">
<h2 class="anchored" data-anchor-id="compute-index">Compute index</h2>
<p>Now we compute the index. First need to base the prices at 2015 as 100: compute the average price for each product for 2015, and merge it back to <strong>M</strong> matrix. These 2015 basis values are used as the denominator when we compute the index.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>basis_2015 <span class="ot">&lt;-</span> <span class="fu">filter</span>(dcommodity, year <span class="sc">==</span> <span class="dv">2015</span>) <span class="sc">|&gt;</span> </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(year, period, time, datetime)) <span class="sc">|&gt;</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">apply</span>(<span class="at">MARGIN =</span> <span class="dv">2</span>, mean) </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>basis_2015 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(basis_2015)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>basis_2015<span class="sc">$</span>description_short <span class="ot">&lt;-</span> <span class="fu">rownames</span>(basis_2015)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(basis_2015)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               basis_2015 description_short
beef            4.5591542              beef
shrimps_mex    13.2152272       shrimps_mex
banana_us       0.9569142         banana_us
coffee_arabica  3.5260692    coffee_arabica
coffee_robusta  1.9411679    coffee_robusta
tea_mombasa     2.9646806       tea_mombasa</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># merge it to M</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>M2 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(M, basis_2015, <span class="at">by =</span> <span class="st">'description_short'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we select the relevant columns (by dropping <code>year, period, time, datetime</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select only relevant columns</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>dcwide <span class="ot">&lt;-</span> <span class="fu">select</span>(dcommodity, <span class="sc">-</span><span class="fu">c</span>(year, period, time, datetime))</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co"># still want to keep track of the time information</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(dcwide) <span class="ot">&lt;-</span> dcommodity<span class="sc">$</span>datetime</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Divide the original values by the 2015 basis, then multiply by their weights. For the special cases (coffee, crude oil), the <em>within_product_weight</em> is used to combine the weighted sum of the two sub-products.</p>
<section id="test-out-for-one-series" class="level3">
<h3 class="anchored" data-anchor-id="test-out-for-one-series">Test out for one series</h3>
<p>Let us use beef as an example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>products <span class="ot">&lt;-</span> M2<span class="sc">$</span>description_short</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>products[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>beef <span class="ot">&lt;-</span> <span class="fu">compute_weighted_price</span>(<span class="at">d_price =</span> dcwide,</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">d_weight =</span> M2,</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">product =</span> products[<span class="dv">1</span>])</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(beef)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result lists are as follow:</p>
<ul>
<li><code>info</code>: basic information for this commodity</li>
<li><code>d_rebase</code>: price after dividing by its 2015 average then multiplied by 100</li>
<li><code>d_weighted</code>: price index after multiplying the re-based values with the share and weight that contribute to the final index.</li>
</ul>
</section>
<section id="repeat-for-all-commodities" class="level3">
<h3 class="anchored" data-anchor-id="repeat-for-all-commodities">Repeat for all commodities</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># do it for all 47 series</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>products <span class="ot">&lt;-</span> M2<span class="sc">$</span>description_short</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>reslist <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(products)){</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  reslist[[i]] <span class="ot">&lt;-</span> <span class="fu">compute_weighted_price</span>(</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">d_price =</span> dcwide,</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">d_weight =</span> M2,</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">product =</span> products[i]</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cat('processing product ', i, '\n')</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(reslist) <span class="ot">&lt;-</span> products</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now put everything together. We extract the weighted series from all commodities, and put them in one matrix.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># put together</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>list_weighted <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(reslist, <span class="cf">function</span>(x){x<span class="sc">$</span>d_weighted})</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>mat_weighted <span class="ot">&lt;-</span> <span class="fu">do.call</span>(cbind, list_weighted)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The final index is the row-sum of all series. Note that for now we have removed all the missing values, but they can also be imputed with historical data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>index <span class="ot">&lt;-</span> <span class="fu">apply</span>(mat_weighted, <span class="dv">1</span>, <span class="cf">function</span>(x)(<span class="fu">sum</span>(x, <span class="at">na.rm =</span> T)))</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index, <span class="at">type =</span> <span class="st">'l'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>